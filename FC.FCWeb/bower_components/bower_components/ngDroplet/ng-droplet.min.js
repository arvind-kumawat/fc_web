(function(n){"use strict";var t=n.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout","$q",function(t,i,r,u){return{restrict:"EA",require:"?ngModel",scope:{"interface":"=ngModel"},controller:["$scope",function(f){f.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8};f.files=[];f.isUploading=!1;f.isError=!1;var e=function(n,t){var r=function(n){return typeof n=="string"?n.toLowerCase():n};return t.some(function(t){var u=t instanceof i.RegExp;return u?t.test(r(n)):r(t)===r(n)})};f.getEvent=function(n){return"originalEvent"in n?n.originalEvent:n};f.isValidHTTPStatus=function(n){return e(n,f.options.statuses.success)};f.isValidExtension=function(n){return e(n,f.options.extensions)};f.options={requestUrl:"",disableXFileSize:!1,parserFn:function(n){return i.JSON.parse(n)},useArray:!0,requestHeaders:{},requestPostData:{},extensions:[],statuses:{success:[/2.{2}/]}};f.requestProgress={percent:0,total:0,loaded:0};f.listeners={files:[],deferred:null,httpRequest:null,success:function(){this.httpRequest.onreadystatechange=function(){if(this.httpRequest.readyState===4){if(f.isValidHTTPStatus(this.httpRequest.status)){f.$apply(function(){var i=f.options.parserFn(this.httpRequest.responseText);t.$broadcast("$dropletSuccess",i,this.files);this.deferred.resolve(i,this.files);f.finishedUploading();n.forEach(this.files,function(n){n.setType(f.FILE_TYPES.UPLOADED)})}.bind(this));return}this.httpRequest.upload.onerror()}}.bind(this)},error:function(){this.httpRequest.upload.onerror=function(){f.$apply(function(){f.finishedUploading();f.isError=!0;var n=f.options.parserFn(this.httpRequest.responseText);t.$broadcast("$dropletError",n);this.deferred.reject(n)}.bind(this))}.bind(this)},progress:function(){var n=f.getRequestLength(this.files);this.httpRequest.upload.onprogress=function(t){f.$apply(function(){t.lengthComputable&&(f.requestProgress.percent=Math.round(t.loaded/n*100),f.requestProgress.loaded=t.loaded,f.requestProgress.total=n)})}}},function(){f.DropletModel=function(){};f.DropletModel.prototype={load:function(n){n instanceof i.File||f.throwException('Loaded files must be an instance of the "File" object');this.file=n;this.date=new i.Date;this.mimeType=n.type;this.extension=f.getExtension(n);t.$broadcast("$dropletFileAdded",this)},deleteFile:function(){this.setType(f.FILE_TYPES.DELETED);t.$broadcast("$dropletFileDeleted",this)},setType:function(n){this.type=n},isImage:function(){return!!this.file.type.match(/^image\//i)}}}();f.finishedUploading=function(){f.progress={percent:0,total:0,loaded:0};f.isUploading=!1};f.forEachFile=function(t,i){n.forEach(f.filterFiles(t||f.FILE_TYPES.VALID),function(n){i(n)})};f.addFile=function(n,t){t=t||f.FILE_TYPES.VALID;var i=new f.DropletModel;return i.load(n),i.setType(t),f.files.push(i),i};f.filterFiles=function(n){return f.files.filter(function(t){return n&t.type})};f.getExtension=function(n){return n.name.indexOf(".")===-1?"":n.name.split(".").pop().trim().toLowerCase()};f.traverseFiles=function(n){for(var t=0,i=n.length;t<i;t++){var r=n[t],e=f.getExtension(r),u=f.FILE_TYPES.VALID;f.isValidExtension(e)||(u=f.FILE_TYPES.INVALID);f.addFile(r,u)}};f.uploadFiles=function(){f.isError=!1;var t=new i.XMLHttpRequest,r=new i.FormData,e=f.filterFiles(f.FILE_TYPES.VALID),s=f.options.useArray?"file[]":"file",h=f.getRequestLength(e),o=u.defer();return t.open("post",f.options.requestUrl,!0),function(){f.options.disableXFileSize||t.setRequestHeader("X-File-Size",h);f.addRequestHeaders(t);f.addPostData(r)}(),function(){f.listeners.files=e;f.listeners.deferred=o;f.listeners.httpRequest=t;f.listeners.progress();f.listeners.success();f.listeners.error()}(),n.forEach(e,function(n){r.append(s,n.file)}),f.isUploading=!0,t.send(r),o.promise};f.addRequestHeaders=function(n){for(var t in f.options.requestHeaders)f.options.requestHeaders.hasOwnProperty(t)&&n.setRequestHeader(t,f.options.requestHeaders[t]);return Object.keys(f.options.requestHeaders)};f.addPostData=function(n){for(var t in f.options.requestPostData)f.options.requestPostData.hasOwnProperty(t)&&n.append(t,f.options.requestPostData[t]);return Object.keys(f.options.requestPostData)};f.getRequestLength=function(n){var t=n||f.filterFiles(f.FILE_TYPES.VALID);return t.reduce(function(n,t){return n+t.file.size},0)};f.throwException=function(n){throw"ngDroplet: "+n+".";},function(){f.interface={FILE_TYPES:f.FILE_TYPES,uploadFiles:f.uploadFiles,progress:f.requestProgress,useParser:function(n){typeof n!="function"&&f.throwException('Parser function must be typeof "function"');f.options.parserFn=n},isUploading:function(){return f.isUploading},isError:function(){return f.isError},isReady:function(){return!!f.filterFiles(f.FILE_TYPES.VALID).length},addFile:f.addFile,traverseFiles:f.traverseFiles,disableXFileSize:function(){f.options.disableXFileSize=!0},useArray:function(n){f.options.useArray=!!n},setRequestUrl:function(n){f.options.requestUrl=n},setRequestHeaders:function(n){f.options.requestHeaders=n},setPostData:function(n){f.options.requestPostData=n},getFiles:function(n){return n?f.filterFiles(n):f.files},allowedExtensions:function(t){n.isArray(t)||f.throwException("Extensions must be an array");f.options.extensions=t},defineHTTPSuccess:function(t){n.isArray(t)||f.throwException("Status list must be an array");f.options.statuses.success=t}};f.interface.allowedExtensions(["png","jpg","bmp","gif","svg","torrent","pdf"]);f.interface.useArray(!0);r(function(){t.$broadcast("$dropletReady")})}()}],link:function(n,t){var i=function(i){i=n.getEvent(i);t.removeClass("event-dragleave");t.removeClass("event-dragenter");t.removeClass("event-dragover");t.removeClass("event-drop");t.addClass("event-"+i.type);i.preventDefault();i.stopPropagation()};t.bind("dragover dragenter dragleave",i);t.bind("drop",function(t){i(t);n.$apply(function(){t=n.getEvent(t);n.traverseFiles(t.dataTransfer.files)})})}}}]).directive("dropletPreview",["$window",function(n){return{scope:{model:"=ngModel"},restrict:"EA",replace:!0,template:'<img ng-show="model.isImage()" style="background-image: url({{imageData}})" class="droplet-preview" />',link:function(t){t.imageData="";var i=new n.FileReader;i.onload=function(n){t.$apply(function(){t.imageData=n.target.result})};t.model.isImage()&&i.readAsDataURL(t.model.file)}}}]);(function(){var n=function(n,i){t.directive(n,function(){return{restrict:"EA",require:"ngModel",replace:!0,template:i,scope:{"interface":"=ngModel"},link:function(n,t){t.bind("change",function(){n.$apply(function(){n.interface.traverseFiles(t[0].files)})})}}})};n("dropletUploadSingle",'<input class="droplet-upload droplet-single" type="file" />');n("dropletUploadMultiple",'<input class="droplet-upload droplet-multiple" type="file" multiple="multiple" />')})()})(window.angular);
//# sourceMappingURL=ng-droplet.min.js.map
